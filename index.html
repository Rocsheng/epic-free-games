<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Epic免费游戏收集 | 喜加一汇总</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome图标 -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#11998e',
            secondary: '#38ef7d',
            accent: '#e74c3c',
            dark: '#2c3e50',
            light: '#f5f7fa'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
      }
      .btn-primary {
        @apply bg-primary text-white px-4 py-2 rounded-lg shadow-md hover:bg-primary/90 transition-all;
      }
      .btn-refresh {
        @apply bg-dark text-white px-3 py-1 rounded-lg shadow-md hover:bg-dark/90 transition-all flex items-center gap-2;
      }
      .btn-email {
        @apply bg-purple-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-all;
      }
      .card-gradient {
        @apply bg-gradient-to-br from-white to-light;
      }
    }
  </style>
  <style>
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    /* 加载动画 */
    .loader {
      border-top-color: #11998e;
      animation: spinner 0.8s linear infinite;
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* 图片加载过渡 */
    .game-image {
      transition: opacity 0.5s ease;
    }
    .game-image.loading {
      opacity: 0;
    }
    .game-image.loaded {
      opacity: 1;
    }
    /* 重试按钮样式 */
    .retry-btn {
      @apply bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all mt-4;
    }
    /* 邮件设置面板样式 */
    .email-panel {
      @apply bg-white p-6 rounded-xl shadow-lg border border-gray-200;
    }
    .email-panel input {
      @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
    }
    .email-panel label {
      @apply block mb-2 font-medium text-gray-700;
    }
    .email-panel .checkbox-group {
      @apply flex items-center mb-4;
    }
    .email-panel .checkbox-group input {
      @apply w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2;
    }
    .email-panel .checkbox-group label {
      @apply ml-2 text-sm font-medium text-gray-700;
    }
    /* 邮件设置按钮 */
    .email-setting-btn {
      @apply bg-purple-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-all flex items-center gap-2;
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 导航栏 -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-2">
        <i class="fa fa-gamepad text-2xl text-primary"></i>
        <h1 class="text-xl md:text-2xl font-bold">Epic免费游戏收集</h1>
      </div>
      
      <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
        <div class="relative w-full md:w-64">
          <input 
            type="text" 
            id="search-input"
            placeholder="搜索游戏名称..." 
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
          >
          <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <button id="refresh-btn" class="btn-refresh">
          <i class="fa fa-refresh"></i>
          <span>刷新</span>
        </button>
        
        <button id="email-setting-btn" class="email-setting-btn">
          <i class="fa fa-envelope"></i>
          <span>邮件提醒</span>
        </button>
        
        <span id="last-update" class="text-sm text-gray-500">
          最后更新: 加载中...
        </span>
      </div>
    </div>
  </header>

  <!-- 邮件设置面板 -->
  <div id="email-panel" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 w-full max-w-md hidden">
    <div class="email-panel relative">
      <button id="close-email-panel" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
        <i class="fa fa-times text-xl"></i>
      </button>
      
      <h2 class="text-xl font-bold mb-4 text-center">邮件提醒设置</h2>
      
      <div class="mb-4">
        <label for="email-input">接收邮件地址</label>
        <input type="email" id="email-input" placeholder="输入您的邮箱地址">
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="enable-email" checked>
        <label for="enable-email">启用邮件提醒功能</label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="include-description">
        <label for="include-description">在邮件中包含游戏描述</label>
      </div>
      
      <div class="flex gap-2 mt-6">
        <button id="save-email-settings" class="btn-primary flex-1">
          保存设置
        </button>
        <button id="test-email-btn" class="btn-email flex-1">
          发送测试邮件
        </button>
      </div>
      
      <div id="email-status" class="mt-4 p-3 rounded-lg hidden"></div>
    </div>
  </div>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 状态提示区 -->
    <div id="status-alert" class="mb-6 p-4 rounded-lg hidden"></div>
    
    <!-- 加载动画 -->
    <div id="loading" class="flex justify-center items-center py-20">
      <div class="loader h-12 w-12 rounded-full border-4 border-gray-200"></div>
    </div>
    
    <!-- 游戏列表 -->
    <div id="games-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden">
      <!-- 游戏卡片将通过JS动态生成 -->
    </div>
    
    <!-- 空状态 -->
    <div id="empty-state" class="flex flex-col items-center justify-center py-20 hidden">
      <div class="bg-gray-100 p-6 rounded-full mb-4">
        <i class="fa fa-inbox text-4xl text-gray-400"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">暂无免费游戏</h3>
      <p class="text-gray-500 text-center max-w-md">
        目前没有可领取的免费游戏，或没有找到符合搜索条件的游戏。<br>
        请稍后再试或尝试其他搜索关键词。
      </p>
    </div>
    
    <!-- 错误状态 -->
    <div id="error-state" class="flex flex-col items-center justify-center py-20 hidden">
      <div class="bg-red-100 p-6 rounded-full mb-4">
        <i class="fa fa-exclamation-circle text-4xl text-accent"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">数据获取失败</h3>
      <p class="text-gray-500 text-center max-w-md mb-4">
        无法连接到Epic游戏服务器，请检查网络连接或稍后重试。<br>
        可能是跨域限制或API暂时不可用。
      </p>
      <button id="retry-btn" class="retry-btn">
        <i class="fa fa-refresh mr-1"></i> 重试连接
      </button>
      <p class="text-xs text-gray-400 mt-4">
        已自动尝试3个不同的代理地址，均失败
      </p>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark text-white py-6">
    <div class="container mx-auto px-4 text-center">
      <p class="mb-2">数据来源于 Epic Games Store 公开API</p>
      <p class="text-sm text-gray-400">
        自动更新周期: 30分钟 | 游戏领取请在截止时间前完成
      </p>
      <div class="mt-4 flex justify-center gap-4">
        <a href="https://store.epicgames.com/free-games" target="_blank" class="text-gray-300 hover:text-white transition-colors">
          <i class="fa fa-external-link mr-1"></i> 前往Epic官网
        </a>
      </div>
    </div>
  </footer>

  <!-- 游戏卡片模板（不显示，仅作为JS克隆用） -->
  <template id="game-card-template">
    <div class="game-card bg-white rounded-xl shadow-md overflow-hidden card-hover card-gradient">
      <!-- 游戏封面图 -->
      <div class="relative h-48 overflow-hidden">
        <img class="game-image w-full h-full object-cover loading" alt="游戏封面">
        <div class="absolute top-2 right-2 bg-accent text-white text-xs font-bold px-2 py-1 rounded">
          免费领取
        </div>
      </div>
      
      <!-- 游戏信息 -->
      <div class="p-4">
        <h3 class="game-title font-bold text-lg mb-2 line-clamp-1"></h3>
        
        <div class="flex items-center text-accent text-sm mb-3">
          <i class="fa fa-clock-o mr-1"></i>
          <span class="game-end-date"></span>
        </div>
        
        <p class="game-description text-gray-600 text-sm mb-4 line-clamp-3"></p>
        
        <a href="#" class="game-link btn-primary w-full inline-block text-center" target="_blank" rel="noopener noreferrer">
          <i class="fa fa-gift mr-1"></i> 立即领取
        </a>
      </div>
    </div>
  </template>

  <script>
    // 全局变量
    const EPIC_API_URL = "https://store-site-backend-static.ak.epicgames.com/freeGamesPromotions?locale=zh";
    // 多个CORS代理地址（备用）
    const CORS_PROXIES = [
      "https://cors-anywhere.herokuapp.com/",
      "https://api.allorigins.win/get?url=",
      "https://proxy.cors.sh/"
    ];
    const CACHE_KEY = "epic_free_games";
    const CACHE_EXPIRE_MINUTES = 30; // 缓存过期时间（分钟）
    let gamesData = []; // 存储游戏数据
    let currentProxyIndex = 0; // 当前使用的代理索引

    // 邮件相关变量
    const EMAIL_SETTINGS_KEY = "email_settings";
    let emailSettings = {
      enabled: false,
      email: "",
      includeDescription: true
    };

    // DOM元素
    const loadingEl = document.getElementById('loading');
    const gamesContainerEl = document.getElementById('games-container');
    const emptyStateEl = document.getElementById('empty-state');
    const errorStateEl = document.getElementById('error-state');
    const refreshBtnEl = document.getElementById('refresh-btn');
    const searchInputEl = document.getElementById('search-input');
    const lastUpdateEl = document.getElementById('last-update');
    const statusAlertEl = document.getElementById('status-alert');
    const gameCardTemplate = document.getElementById('game-card-template');
    const retryBtnEl = document.getElementById('retry-btn');

    // 邮件面板相关DOM元素
    const emailSettingBtnEl = document.getElementById('email-setting-btn');
    const emailPanelEl = document.getElementById('email-panel');
    const closeEmailPanelBtn = document.getElementById('close-email-panel');
    const emailInputEl = document.getElementById('email-input');
    const enableEmailEl = document.getElementById('enable-email');
    const includeDescriptionEl = document.getElementById('include-description');
    const saveEmailSettingsBtn = document.getElementById('save-email-settings');
    const testEmailBtn = document.getElementById('test-email-btn');
    const emailStatusEl = document.getElementById('email-status');

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 加载缓存数据
      loadCachedGames();
      
      // 加载邮件设置
      loadEmailSettings();
      
      // 绑定事件
      refreshBtnEl.addEventListener('click', refreshGames);
      searchInputEl.addEventListener('input', filterGames);
      retryBtnEl.addEventListener('click', retryAllProxies);
      
      // 邮件设置面板事件
      emailSettingBtnEl.addEventListener('click', showEmailPanel);
      closeEmailPanelBtn.addEventListener('click', hideEmailPanel);
      saveEmailSettingsBtn.addEventListener('click', saveEmailSettings);
      testEmailBtn.addEventListener('click', sendTestEmail);
      
      // 点击面板外部关闭
      document.addEventListener('click', (e) => {
        if (emailPanelEl.classList.contains('hidden')) return;
        if (!emailPanelEl.contains(e.target) && e.target !== emailSettingBtnEl) {
          hideEmailPanel();
        }
      });
      
      // 自动刷新
      setInterval(refreshGames, CACHE_EXPIRE_MINUTES * 60 * 1000);
    });

    /**
     * 加载邮件设置
     */
    function loadEmailSettings() {
      const savedSettings = localStorage.getItem(EMAIL_SETTINGS_KEY);
      if (savedSettings) {
        emailSettings = JSON.parse(savedSettings);
        emailInputEl.value = emailSettings.email;
        enableEmailEl.checked = emailSettings.enabled;
        includeDescriptionEl.checked = emailSettings.includeDescription;
      } else {
        // 默认设置
        emailSettings = {
          enabled: false,
          email: "",
          includeDescription: true
        };
      }
    }

    /**
     * 保存邮件设置
     */
    function saveEmailSettings() {
      const newEmail = emailInputEl.value.trim();
      if (emailSettings.enabled && !isValidEmail(newEmail)) {
        showEmailStatus('请输入有效的邮箱地址', 'error');
        return;
      }
      
      emailSettings = {
        enabled: enableEmailEl.checked,
        email: newEmail,
        includeDescription: includeDescriptionEl.checked
      };
      
      localStorage.setItem(EMAIL_SETTINGS_KEY, JSON.stringify(emailSettings));
      showEmailStatus('邮件设置已保存', 'success');
      
      // 延迟隐藏面板
      setTimeout(() => {
        hideEmailPanel();
      }, 1500);
    }

    /**
     * 显示邮件面板
     */
    function showEmailPanel() {
      emailPanelEl.classList.remove('hidden');
    }

    /**
     * 隐藏邮件面板
     */
    function hideEmailPanel() {
      emailPanelEl.classList.add('hidden');
    }

    /**
     * 发送测试邮件
     */
    async function sendTestEmail() {
      if (!emailSettings.enabled) {
        showEmailStatus('请先启用邮件提醒功能', 'warning');
        return;
      }
      
      const testEmail = emailInputEl.value.trim();
      if (!isValidEmail(testEmail)) {
        showEmailStatus('请输入有效的邮箱地址', 'error');
        return;
      }
      
      showEmailStatus('正在发送测试邮件...', 'info');
      
      try {
        // 创建测试邮件内容
        const testGame = {
          title: "测试游戏",
          description: "这是一封测试邮件，用于验证邮件提醒功能是否正常工作。",
          link: "https://store.epicgames.com/free-games",
          endDate: new Date().toLocaleString() + " (UTC)"
        };
        
        // 发送邮件到后端API（这里使用模拟的API端点）
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            to: testEmail,
            subject: 'Epic免费游戏提醒 - 测试邮件',
            html: createEmailContent([testGame], '测试邮件')
          })
        });
        
        if (response.ok) {
          showEmailStatus('测试邮件发送成功！', 'success');
        } else {
          showEmailStatus('测试邮件发送失败，请检查设置', 'error');
        }
      } catch (error) {
        console.error('发送测试邮件失败:', error);
        showEmailStatus('发送测试邮件时发生错误', 'error');
      }
    }

    /**
     * 显示邮件状态
     */
    function showEmailStatus(message, type) {
      let bgColor, textColor;
      switch(type) {
        case 'success':
          bgColor = 'bg-green-100';
          textColor = 'text-green-700';
          break;
        case 'error':
          bgColor = 'bg-red-100';
          textColor = 'text-red-700';
          break;
        case 'warning':
          bgColor = 'bg-yellow-100';
          textColor = 'text-yellow-700';
          break;
        case 'info':
          bgColor = 'bg-blue-100';
          textColor = 'text-blue-700';
          break;
        default:
          bgColor = 'bg-gray-100';
          textColor = 'text-gray-700';
      }
      
      emailStatusEl.className = `p-3 rounded-lg ${bgColor} ${textColor}`;
      emailStatusEl.textContent = message;
      emailStatusEl.classList.remove('hidden');
      
      // 3秒后隐藏状态消息
      setTimeout(() => {
        emailStatusEl.classList.add('hidden');
      }, 3000);
    }

    /**
     * 验证邮箱格式
     */
    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    /**
     * 加载缓存数据
     */
    async function loadCachedGames() {
      try {
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
          const { games, timestamp } = JSON.parse(cachedData);
          const now = new Date().getTime();
          
          // 检查缓存是否过期
          if (now - timestamp < CACHE_EXPIRE_MINUTES * 60 * 1000) {
            gamesData = games;
            renderGames(games);
            updateLastUpdate(timestamp);
            showSuccessAlert(`已加载缓存数据 (${games.length} 款游戏)`);
            
            // 检查新游戏并发送邮件提醒
            checkAndSendEmailAlerts(games);
            return;
          }
        }
        
        // 缓存过期或无缓存，获取新数据
        await fetchGamesWithProxy();
      } catch (error) {
        console.error('加载缓存失败:', error);
        await fetchGamesWithProxy();
      }
    }

    /**
     * 检查新游戏并发送邮件提醒
     */
    function checkAndSendEmailAlerts(newGames) {
      if (!emailSettings.enabled || !emailSettings.email) {
        return; // 邮件功能未启用或未设置邮箱
      }
      
      // 从localStorage获取之前的游戏列表
      const previousGames = JSON.parse(localStorage.getItem('previous_games') || '[]');
      
      // 找出新游戏（当前有但之前没有的游戏）
      const newGameList = newGames.filter(currentGame => 
        !previousGames.some(prevGame => prevGame.title === currentGame.title)
      );
      
      if (newGameList.length > 0) {
        // 发送邮件提醒
        sendEmailAlert(newGameList);
        
        // 更新之前的列表
        localStorage.setItem('previous_games', JSON.stringify(newGames));
      } else {
        // 没有新游戏，但仍然更新之前的列表
        localStorage.setItem('previous_games', JSON.stringify(newGames));
      }
    }

    /**
     * 发送邮件提醒
     */
    async function sendEmailAlert(games) {
      if (!emailSettings.enabled || !emailSettings.email) {
        return;
      }
      
      try {
        // 创建邮件内容
        const htmlContent = createEmailContent(games, '新免费游戏上线');
        
        // 发送邮件到后端API（这里使用模拟的API端点）
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            to: emailSettings.email,
            subject: `Epic免费游戏提醒 - ${games.length}款新游戏上线`,
            html: htmlContent
          })
        });
        
        if (response.ok) {
          console.log(`邮件提醒已发送给: ${emailSettings.email}`);
          showSuccessAlert(`已向 ${emailSettings.email} 发送 ${games.length} 款新游戏提醒邮件`);
        } else {
          console.error('发送邮件失败:', await response.text());
          showWarningAlert('邮件发送失败，但新游戏已检测到');
        }
      } catch (error) {
        console.error('发送邮件时发生错误:', error);
        showWarningAlert('邮件发送失败，但新游戏已检测到');
      }
    }

    /**
     * 创建邮件内容
     */
    function createEmailContent(games, title) {
      let gamesHtml = '';
      games.forEach(game => {
        gamesHtml += `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fafafa;">
            <h3 style="margin: 0 0 10px; color: #2c3e50; font-size: 18px;">${game.title}</h3>
            ${emailSettings.includeDescription ? `<p style="margin: 0 0 10px; color: #555;">${game.description}</p>` : ''}
            <p style="margin: 0 0 10px; color: #e74c3c; font-weight: bold;">截止时间: ${game.endDate}</p>
            <a href="${game.link}" style="display: inline-block; background-color: #11998e; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px;">立即领取</a>
          </div>
        `;
      });
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Epic免费游戏提醒</title>
        </head>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
            <h1 style="color: #2c3e50; text-align: center; border-bottom: 2px solid #11998e; padding-bottom: 10px;">Epic免费游戏提醒</h1>
            <h2 style="color: #11998e; text-align: center; margin-top: 20px;">${title}</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">您设置的提醒已触发，以下是新上线的免费游戏：</p>
            ${gamesHtml}
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            <p style="text-align: center; color: #999; font-size: 12px;">
              此邮件由Epic免费游戏收集网站自动发送，请勿回复。<br>
              如需修改邮件设置，请访问我们的网站。
            </p>
          </div>
        </body>
        </html>
      `;
    }

    /**
     * 使用CORS代理获取游戏数据
     */
    async function fetchGamesWithProxy() {
      showLoading();
      let proxyIndex = currentProxyIndex;
      let success = false;
      
      try {
        // 尝试所有代理地址
        for (let i = 0; i < CORS_PROXIES.length; i++) {
          const proxyUrl = CORS_PROXIES[proxyIndex];
          let apiUrl;
          
          // 处理不同代理的URL格式
          if (proxyUrl.includes("allorigins")) {
            // allorigins代理需要特殊处理
            apiUrl = `${proxyUrl}${encodeURIComponent(EPIC_API_URL)}`;
          } else {
            apiUrl = `${proxyUrl}${EPIC_API_URL}`;
          }
          
          console.log(`尝试使用代理 ${proxyIndex + 1}/${CORS_PROXIES.length}: ${proxyUrl}`);
          
          try {
            const response = await fetch(apiUrl, {
              method: 'GET',
              headers: {
                'Accept': 'application/json',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
              },
              timeout: 15000 // 15秒超时
            });
            
            if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
            
            let data;
            // 处理allorigins的响应格式
            if (proxyUrl.includes("allorigins")) {
              const result = await response.json();
              data = JSON.parse(result.contents);
            } else {
              data = await response.json();
            }
            
            const elements = data?.data?.Catalog?.searchStore?.elements || [];
            
            // 过滤和处理游戏数据
            const freeGames = processGameData(elements);
            gamesData = freeGames;
            
            // 检查新游戏并发送邮件提醒
            checkAndSendEmailAlerts(freeGames);
            
            // 缓存数据
            localStorage.setItem(CACHE_KEY, JSON.stringify({
              games: freeGames,
              timestamp: new Date().getTime()
            }));
            
            // 更新当前使用的代理索引（下次优先使用成功的代理）
            currentProxyIndex = proxyIndex;
            
            renderGames(freeGames);
            updateLastUpdate(new Date().getTime());
            showSuccessAlert(`成功获取 ${freeGames.length} 款免费游戏 (使用代理 ${proxyIndex + 1})`);
            success = true;
            break; // 成功后退出循环
          } catch (proxyError) {
            console.error(`代理 ${proxyIndex + 1} 失败:`, proxyError);
            // 切换到下一个代理
            proxyIndex = (proxyIndex + 1) % CORS_PROXIES.length;
          }
        }
        
        if (!success) {
          throw new Error("所有代理地址都无法连接");
        }
      } catch (error) {
        console.error('获取游戏数据失败:', error);
        showErrorAlert('获取游戏数据失败，请检查网络连接或稍后重试');
        
        // 如果有缓存数据，使用缓存
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
          const { games, timestamp } = JSON.parse(cachedData);
          gamesData = games;
          renderGames(games);
          updateLastUpdate(timestamp);
          showWarningAlert('已加载缓存数据，可能不是最新的');
        } else {
          // 无缓存，显示错误状态
          showErrorState();
        }
      } finally {
        hideLoading();
      }
    }

    /**
     * 重试所有代理
     */
    async function retryAllProxies() {
      showLoading();
      await fetchGamesWithProxy();
    }

    /**
     * 处理游戏数据（过滤、格式化）
     */
    function processGameData(elements) {
      const freeGames = [];
      
      elements.forEach(game => {
        const promotions = game?.promotions;
        if (!promotions || !promotions?.promotionalOffers || promotions?.promotionalOffers.length === 0) {
          return;
        }
        
        // 检查是否有免费优惠
        let isFree = false;
        let endDateStr = "未知";
        
        promotions.promotionalOffers.forEach(offerGroup => {
          offerGroup.promotionalOffers.forEach(offer => {
            if (offer.discountSetting.discountPercentage === 0) {
              isFree = true;
              
              // 格式化截止时间
              if (offer.endDate) {
                try {
                  const dtEnd = new Date(offer.endDate.split('.')[0]);
                  endDateStr = `${dtEnd.getFullYear()}-${(dtEnd.getMonth() + 1).toString().padStart(2, '0')}-${dtEnd.getDate().toString().padStart(2, '0')} ${dtEnd.getHours().toString().padStart(2, '0')}:${dtEnd.getMinutes().toString().padStart(2, '0')} (UTC)`;
                } catch (e) {
                  endDateStr = offer.endDate;
                }
              }
            }
          });
        });
        
        if (isFree) {
          // 获取游戏链接
          const slug = game.productSlug || game.urlSlug;
          const link = slug ? `https://store.epicgames.com/p/${slug}` : "https://store.epicgames.com/free-games";
          
          // 获取游戏图片
          let imageUrl = "";
          game.keyImages?.forEach(img => {
            if ((img.type === 'Thumbnail' || img.type === 'OfferImageWide') && !imageUrl) {
              imageUrl = img.url;
            }
          });
          
          freeGames.push({
            title: game.title || "未知游戏",
            description: game.description || "暂无描述",
            link: link,
            image: imageUrl,
            endDate: endDateStr,
            originalData: game // 保留原始数据
          });
        }
      });
      
      // 按截止时间排序（最近到期的在前）
      return freeGames.sort((a, b) => {
        try {
          const dateA = new Date(a.endDate.replace(' (UTC)', ''));
          const dateB = new Date(b.endDate.replace(' (UTC)', ''));
          return isNaN(dateA.getTime()) ? 1 : isNaN(dateB.getTime()) ? -1 : dateA - dateB;
        } catch (e) {
          return 0;
        }
      });
    }

    /**
     * 渲染游戏列表
     */
    function renderGames(games) {
      gamesContainerEl.innerHTML = '';
      
      if (games.length === 0) {
        showEmptyState();
        return;
      }
      
      games.forEach(game => {
        const card = gameCardTemplate.content.cloneNode(true);
        
        // 设置卡片数据
        const imgEl = card.querySelector('.game-image');
        imgEl.src = game.image || 'https://via.placeholder.com/400x225?text=暂无图片';
        imgEl.alt = game.title;
        imgEl.onload = () => imgEl.classList.add('loaded');
        
        card.querySelector('.game-title').textContent = game.title;
        card.querySelector('.game-end-date').textContent = `截止: ${game.endDate}`;
        card.querySelector('.game-description').textContent = game.description;
        
        const linkEl = card.querySelector('.game-link');
        linkEl.href = game.link;
        linkEl.target = "_blank";
        
        gamesContainerEl.appendChild(card);
      });
      
      gamesContainerEl.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');
      errorStateEl.classList.add('hidden');
    }

    /**
     * 过滤游戏（搜索功能）
     */
    function filterGames() {
      const searchTerm = searchInputEl.value.trim().toLowerCase();
      
      if (!searchTerm) {
        renderGames(gamesData);
        return;
      }
      
      const filteredGames = gamesData.filter(game => 
        game.title.toLowerCase().includes(searchTerm) || 
        game.description.toLowerCase().includes(searchTerm)
      );
      
      renderGames(filteredGames);
      
      if (filteredGames.length === 0) {
        showWarningAlert(`未找到包含"${searchTerm}"的游戏`);
      } else {
        hideAlert();
      }
    }

    /**
     * 刷新游戏数据
     */
    async function refreshGames() {
      refreshBtnEl.disabled = true;
      refreshBtnEl.innerHTML = '<i class="fa fa-refresh fa-spin"></i><span>刷新中...</span>';
      
      try {
        await fetchGamesWithProxy();
      } finally {
        refreshBtnEl.disabled = false;
        refreshBtnEl.innerHTML = '<i class="fa fa-refresh"></i><span>刷新</span>';
      }
    }

    /**
     * 更新最后更新时间显示
     */
    function updateLastUpdate(timestamp) {
      const date = new Date(timestamp);
      const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      lastUpdateEl.textContent = `最后更新: ${formattedDate}`;
    }

    /**
     * 显示加载状态
     */
    function showLoading() {
      loadingEl.classList.remove('hidden');
      gamesContainerEl.classList.add('hidden');
      emptyStateEl.classList.add('hidden');
      errorStateEl.classList.add('hidden');
      hideAlert();
    }

    /**
     * 隐藏加载状态
     */
    function hideLoading() {
      loadingEl.classList.add('hidden');
    }

    /**
     * 显示空状态
     */
    function showEmptyState() {
      emptyStateEl.classList.remove('hidden');
      gamesContainerEl.classList.add('hidden');
      errorStateEl.classList.add('hidden');
    }

    /**
     * 显示错误状态
     */
    function showErrorState() {
      errorStateEl.classList.remove('hidden');
      gamesContainerEl.classList.add('hidden');
      emptyStateEl.classList.add('hidden');
    }

    /**
     * 显示成功提示
     */
    function showSuccessAlert(message) {
      statusAlertEl.className = 'mb-6 p-4 rounded-lg bg-green-50 text-green-700 border border-green-200';
      statusAlertEl.innerHTML = `<i class="fa fa-check-circle mr-2"></i> ${message}`;
      statusAlertEl.classList.remove('hidden');
      setTimeout(hideAlert, 5000);
    }

    /**
     * 显示错误提示
     */
    function showErrorAlert(message) {
      statusAlertEl.className = 'mb-6 p-4 rounded-lg bg-red-50 text-red-700 border border-red-200';
      statusAlertEl.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> ${message}`;
      statusAlertEl.classList.remove('hidden');
    }

    /**
     * 显示警告提示
     */
    function showWarningAlert(message) {
      statusAlertEl.className = 'mb-6 p-4 rounded-lg bg-yellow-50 text-yellow-700 border border-yellow-200';
      statusAlertEl.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i> ${message}`;
      statusAlertEl.classList.remove('hidden');
    }

    /**
     * 隐藏提示
     */
    function hideAlert() {
      statusAlertEl.classList.add('hidden');
    }

    /**
     * 处理图片加载失败
     */
    document.addEventListener('error', (e) => {
      if (e.target.tagName === 'IMG' && e.target.classList.contains('game-image')) {
        e.target.src = 'https://via.placeholder.com/400x225?text=图片加载失败';
        e.target.classList.add('loaded');
      }
    }, true);

    /**
     * 处理代理可能需要的预请求
     */
    async function preflightProxy() {
      try {
        // 预请求cors-anywhere以获取临时访问权限
        await fetch('https://cors-anywhere.herokuapp.com/corsdemo', {
          method: 'GET',
          timeout: 5000
        });
        console.log('CORS代理预请求完成');
      } catch (e) {
        console.log('CORS代理预请求失败，将尝试其他代理:', e);
      }
    }

    // 页面加载时预请求代理
    preflightProxy();
  </script>
</body>
</html>